<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Moments</title>
  <meta name="apple-itunes-app" content="app-id=6670760989" id="smartBanner">
  <meta property="og:title" content="Moments – Møt nye folk">
  <meta property="og:description" content="Oppdag aktiviteter, bli med i grupper og møt nye folk med Moments.">
  <meta property="og:url" content="">
  <meta property="og:type" content="website">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
      background: #FFFFFF;
      color: #30234B;
      min-height: 100vh;
      display: -webkit-flex;
      display: flex;
      -webkit-flex-direction: column;
      flex-direction: column;
      -webkit-align-items: center;
      align-items: center;
      -webkit-justify-content: center;
      justify-content: center;
      padding: 24px;
      text-align: center;
    }
    .iab-banner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #FFF8E1;
      border-bottom: 1px solid #FFE082;
      padding: 16px 20px;
      z-index: 100;
      text-align: left;
    }
    .iab-banner.show { display: block; }
    .iab-title {
      font-size: 14px;
      font-weight: 600;
      color: #E65100;
      margin-bottom: 8px;
    }
    .iab-steps {
      font-size: 13px;
      color: #5D4037;
      line-height: 1.6;
      margin-bottom: 12px;
    }
    .iab-copy-btn {
      display: inline-block;
      background: #30234B;
      color: white;
      font-size: 13px;
      font-weight: 600;
      padding: 8px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .iab-copy-btn:active { opacity: 0.9; }
    .toast {
      display: none;
      position: fixed;
      bottom: 40px;
      left: 50%;
      -webkit-transform: translateX(-50%);
      transform: translateX(-50%);
      background: #30234B;
      color: white;
      font-size: 14px;
      font-weight: 500;
      padding: 12px 24px;
      border-radius: 12px;
      z-index: 200;
      white-space: nowrap;
    }
    .toast.show {
      display: block;
      -webkit-animation: fadeout 0.5s ease 2s forwards;
      animation: fadeout 0.5s ease 2s forwards;
    }
    @-webkit-keyframes fadeout { to { opacity: 0; } }
    @keyframes fadeout { to { opacity: 0; } }
    .logo {
      width: 80px;
      height: 80px;
      background: #30234B;
      border-radius: 20px;
      display: -webkit-flex;
      display: flex;
      -webkit-align-items: center;
      align-items: center;
      -webkit-justify-content: center;
      justify-content: center;
      margin-bottom: 24px;
    }
    .logo span {
      color: white;
      font-size: 36px;
      font-weight: 700;
    }
    h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #30234B;
    }
    .subtitle {
      font-size: 16px;
      color: #666;
      margin-bottom: 32px;
      line-height: 1.5;
      max-width: 320px;
    }
    .open-btn {
      display: inline-block;
      background: #30234B;
      color: white;
      font-size: 16px;
      font-weight: 600;
      padding: 14px 40px;
      border-radius: 12px;
      text-decoration: none;
      margin-bottom: 16px;
      cursor: pointer;
      border: none;
      -webkit-tap-highlight-color: transparent;
    }
    .open-btn:active { opacity: 0.9; }
    .download-btn {
      display: inline-block;
      background: transparent;
      color: #30234B;
      font-size: 15px;
      font-weight: 500;
      padding: 12px 32px;
      border-radius: 12px;
      text-decoration: none;
      border: 1.5px solid #E0E0E0;
      margin-bottom: 12px;
    }
    .download-btn:active { opacity: 0.8; }
    .links {
      display: -webkit-flex;
      display: flex;
      -webkit-flex-direction: column;
      flex-direction: column;
      gap: 10px;
      -webkit-align-items: center;
      align-items: center;
    }
    .linktree {
      font-size: 13px;
      color: #999;
      margin-top: 24px;
    }
    .linktree a {
      color: #7B61FF;
      text-decoration: none;
    }
    .type-badge {
      display: inline-block;
      background: #F3F2F8;
      color: #30234B;
      font-size: 13px;
      font-weight: 500;
      padding: 6px 14px;
      border-radius: 20px;
      margin-bottom: 16px;
    }
    .preview-img {
      width: 100%;
      max-width: 280px;
      border-radius: 16px;
      margin-bottom: 24px;
    }
  </style>
</head>
<body>

  <!-- IAB banner (hidden by default, shown by JS if in-app browser) -->
  <div class="iab-banner" id="iabBanner">
    <div class="iab-title" id="iabTitle"></div>
    <div class="iab-steps" id="iabSteps"></div>
    <button class="iab-copy-btn" id="iabCopyBtn">Kopier lenke</button>
  </div>
  <div class="toast" id="toast"></div>

  <!-- All default content is visible without JavaScript -->
  <div id="logoContainer"><div class="logo"><span>M</span></div></div>
  <div class="type-badge" id="typeBadge" style="display:none;"></div>
  <h1 id="heading">Se dette i Moments</h1>
  <p class="subtitle" id="subtitle">Trykk for å åpne i appen. Hvis du ikke har appen, last den ned fra App Store.</p>
  <div class="links">
    <a class="open-btn" id="openBtn" href="https://apps.apple.com/no/app/moments-aktiviteter/id6670760989?l=nb">Åpne i appen</a>
    <a class="download-btn" id="downloadBtn" href="https://apps.apple.com/no/app/moments-aktiviteter/id6670760989?l=nb">Last ned fra App Store</a>
    <a class="download-btn" id="googlePlayBtn" href="https://play.google.com/store/apps/details?id=no.momentsapp">Last ned fra Google Play</a>
  </div>
  <div class="linktree" id="linktree">Finn oss på <a href="https://linktr.ee/Moments_App">Linktree</a></div>

  <!-- All JavaScript at end of body, fully ES5, wrapped in try/catch -->
  <script>
    try {
    (function() {
      var APP_STORE = 'https://apps.apple.com/no/app/moments-aktiviteter/id6670760989?l=nb';
      var path = window.location.pathname;
      var fullUrl = window.location.href;
      var match = path.match(/^\/(event|group|profile)\/([a-zA-Z0-9-]+)/);
      var type = match ? match[1] : null;
      var id = match ? match[2] : null;
      var appUrl = (type && id) ? 'momentsapp://' + type + '/' + id : null;

      var isEn = (navigator.language || '').toLowerCase().indexOf('en') === 0;

      // --- In-app browser detection ---
      var ua = navigator.userAgent || '';
      var isIAB = /FBAN|FBAV|FB_IAB|Instagram|Messenger|Musical\.ly|BytedanceWebview|Snapchat|Twitter|LinkedInApp/i.test(ua);

      // --- Get DOM elements ---
      var badge = document.getElementById('typeBadge');
      var heading = document.getElementById('heading');
      var subtitle = document.getElementById('subtitle');
      var openBtn = document.getElementById('openBtn');
      var downloadBtn = document.getElementById('downloadBtn');
      var googlePlayBtn = document.getElementById('googlePlayBtn');
      var linktree = document.getElementById('linktree');
      var logoContainer = document.getElementById('logoContainer');

      // --- English translations (Norwegian is already in the HTML) ---
      if (isEn) {
        document.documentElement.lang = 'en';
        if (heading) { heading.textContent = type ? 'View this in Moments' : 'Moments'; }
        if (subtitle) { subtitle.textContent = type ? 'Tap to open in the app. If you don\'t have it yet, download it from the App Store.' : 'Discover activities, join groups, and meet new people.'; }
        if (openBtn) { openBtn.textContent = 'Open in app'; }
        if (downloadBtn) { downloadBtn.textContent = 'Download from App Store'; }
        if (googlePlayBtn) { googlePlayBtn.textContent = 'Download from Google Play'; }
        if (linktree) { linktree.innerHTML = 'Find us on <a href="https://linktr.ee/Moments_App">Linktree</a>'; }
      }

      // --- Type badge ---
      if (type && badge) {
        var typeLabels = isEn
          ? { event: 'Event', group: 'Group', profile: 'Profile' }
          : { event: 'Aktivitet', group: 'Gruppe', profile: 'Profil' };
        badge.textContent = typeLabels[type] || '';
        badge.style.display = 'inline-block';
      }

      // --- Fallback heading if no type ---
      if (!type) {
        if (heading) { heading.textContent = isEn ? 'Moments' : 'Moments'; }
        if (subtitle) { subtitle.textContent = isEn ? 'Discover activities, join groups, and meet new people.' : 'Oppdag aktiviteter, bli med i grupper og m\u00f8t nye folk.'; }
      }

      // --- OG tags ---
      var ogTitleTag = document.querySelector('meta[property="og:title"]');
      var ogDescTag = document.querySelector('meta[property="og:description"]');
      var ogUrlTag = document.querySelector('meta[property="og:url"]');
      var ogTitle = isEn ? 'Moments \u2013 Meet new people' : 'Moments \u2013 M\u00f8t nye folk';
      var ogDesc = isEn ? 'Discover activities, join groups, and meet new people with Moments.' : 'Oppdag aktiviteter, bli med i grupper og m\u00f8t nye folk med Moments.';
      if (ogTitleTag) { ogTitleTag.setAttribute('content', type ? ((isEn ? (type.charAt(0).toUpperCase() + type.slice(1)) : (typeLabels ? typeLabels[type] : type)) + ' \u2013 Moments') : ogTitle); }
      if (ogDescTag) { ogDescTag.setAttribute('content', ogDesc); }
      if (ogUrlTag) { ogUrlTag.setAttribute('content', fullUrl); }

      // --- Smart App Banner with deep link ---
      var smartBanner = document.getElementById('smartBanner');
      if (smartBanner && appUrl) {
        smartBanner.setAttribute('content', 'app-id=6670760989, app-argument=' + appUrl);
      }

      // --- In-app browser banner ---
      if (isIAB) {
        var iabBanner = document.getElementById('iabBanner');
        var iabTitle = document.getElementById('iabTitle');
        var iabSteps = document.getElementById('iabSteps');
        var iabCopyBtn = document.getElementById('iabCopyBtn');

        if (iabTitle) { iabTitle.textContent = isEn ? '\u26a0\ufe0f You are in an in-app browser' : '\u26a0\ufe0f Du er i en innebygd nettleser'; }
        if (iabSteps) { iabSteps.textContent = isEn ? '1. Tap \u22ef in the top right\n2. Select "Open in Safari"' : '1. Trykk \u22ef \u00f8verst til h\u00f8yre\n2. Velg \u00abÅpne i Safari\u00bb'; }
        if (iabCopyBtn) { iabCopyBtn.textContent = isEn ? 'Copy link' : 'Kopier lenke'; }
        if (iabBanner) { iabBanner.className = 'iab-banner show'; }

        document.body.style.paddingTop = '120px';

        if (iabCopyBtn) {
          iabCopyBtn.onclick = function() {
            copyToClipboard(fullUrl);
            showToast(isEn ? '\u2713 Link copied! Paste in Safari.' : '\u2713 Lenke kopiert! Lim inn i Safari.');
          };
        }
      }

      // --- Clipboard deep link (deferred deep linking) ---
      if (!isIAB) {
        copyToClipboard(fullUrl);
      }

      // --- Open button click handler ---
      if (openBtn) {
        openBtn.onclick = function(e) {
          if (!appUrl) { return; }
          e.preventDefault();
          window.location.href = appUrl;

          var redirectTimer = setTimeout(function() {
            if (!document.hidden) {
              window.location.href = APP_STORE;
            }
          }, 2500);

          var onVisChange = function() {
            if (document.hidden) {
              clearTimeout(redirectTimer);
              document.removeEventListener('visibilitychange', onVisChange, false);
            }
          };
          document.addEventListener('visibilitychange', onVisChange, false);
        };
      }

      // --- Fetch event/group data from Supabase (non-blocking enhancement) ---
      try {
        if (type && id && (type === 'event' || type === 'group') && typeof fetch === 'function') {
          var SUPABASE_URL = 'https://ynuvtpkdxvzlmfqbuvvn.supabase.co';
          var ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InludXZ0cGtkeHZ6bG1mcWJ1dnZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTIyNDYwNzQsImV4cCI6MjAyNzgyMjA3NH0.mua9EwOROb26EnU7HOTl8thxIzBJ_ox52jzVVDCYfjg';
          var fetchHeaders = { 'apikey': ANON_KEY, 'Authorization': 'Bearer ' + ANON_KEY };

          var fetchUrl = type === 'event'
            ? SUPABASE_URL + '/rest/v1/event?id=eq.' + id + '&select=title,description'
            : SUPABASE_URL + '/rest/v1/group?id=eq.' + id + '&select=title,description,header_image_path';

          console.log('[Moments] Fetching:', fetchUrl);
          fetch(fetchUrl, { headers: fetchHeaders })
            .then(function(r) {
              console.log('[Moments] Status:', r.status);
              if (!r.ok) { throw new Error('HTTP ' + r.status); }
              return r.json();
            })
            .then(function(rows) {
              console.log('[Moments] Data:', rows);
              if (!rows || !rows.length) { return; }
              var item = rows[0];

              if (item.title && heading) {
                heading.textContent = item.title;
                document.title = item.title + ' \u2013 Moments';
              }

              if (item.description && subtitle) {
                var desc = item.description.length > 150
                  ? item.description.substring(0, 150) + '\u2026'
                  : item.description;
                subtitle.textContent = desc;
              }

              if (type === 'group' && item.header_image_path) {
                loadPreviewImage(SUPABASE_URL + '/storage/v1/object/public/event_images/' + item.header_image_path);
              } else if (type === 'event') {
                fetch(SUPABASE_URL + '/rest/v1/event_images?event_id=eq.' + id + '&select=image_path&order=sort_order.asc&limit=1', { headers: fetchHeaders })
                  .then(function(r) { return r.json(); })
                  .then(function(imgs) {
                    console.log('[Moments] Images:', imgs);
                    if (imgs && imgs.length && imgs[0] && imgs[0].image_path) {
                      loadPreviewImage(SUPABASE_URL + '/storage/v1/object/public/event_images/' + imgs[0].image_path);
                    }
                  })
                  .catch(function(err) { console.error('[Moments] Image fetch error:', err); });
              }
            })
            .catch(function(err) {
              console.error('[Moments] Fetch error:', err);
            });
        }
      } catch (fetchErr) {
        console.error('[Moments] Fetch block error:', fetchErr);
      }

      function loadPreviewImage(src) {
        try {
          var img = document.createElement('img');
          img.className = 'preview-img';
          img.alt = '';
          img.onload = function() {
            if (logoContainer) {
              logoContainer.innerHTML = '';
              logoContainer.appendChild(img);
            }
          };
          img.onerror = function() {
            console.error('[Moments] Image load failed:', src);
          };
          img.src = src;
        } catch (e) {
          console.error('[Moments] loadPreviewImage error:', e);
        }
      }

      function copyToClipboard(text) {
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text);
          } else {
            var ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
          }
        } catch (e) {
          // fail silently
        }
      }

      function showToast(msg) {
        var toast = document.getElementById('toast');
        if (!toast) { return; }
        toast.textContent = msg;
        toast.className = 'toast';
        void toast.offsetWidth;
        toast.className = 'toast show';
        setTimeout(function() {
          toast.className = 'toast';
        }, 2500);
      }
    })();
    } catch (e) {
      // Page content is already visible from HTML — JS failure is non-fatal
      if (typeof console !== 'undefined') { console.error('[Moments] Fatal JS error:', e); }
    }
  </script>
</body>
</html>
