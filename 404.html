<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Moments</title>
  <meta name="apple-itunes-app" content="app-id=6670760989" id="smartBanner">
  <meta property="og:title" content="Moments – Møt nye folk">
  <meta property="og:description" content="Oppdag aktiviteter, bli med i grupper og møt nye folk med Moments.">
  <meta property="og:url" content="">
  <meta property="og:type" content="website">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
      background: #FFFFFF;
      color: #30234B;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      text-align: center;
    }
    .iab-banner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #FFF8E1;
      border-bottom: 1px solid #FFE082;
      padding: 16px 20px;
      z-index: 100;
      text-align: left;
    }
    .iab-banner.show { display: block; }
    .iab-title {
      font-size: 14px;
      font-weight: 600;
      color: #E65100;
      margin-bottom: 8px;
    }
    .iab-steps {
      font-size: 13px;
      color: #5D4037;
      line-height: 1.6;
      margin-bottom: 12px;
    }
    .iab-copy-btn {
      display: inline-block;
      background: #30234B;
      color: white;
      font-size: 13px;
      font-weight: 600;
      padding: 8px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .iab-copy-btn:active { opacity: 0.9; }
    .toast {
      display: none;
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      background: #30234B;
      color: white;
      font-size: 14px;
      font-weight: 500;
      padding: 12px 24px;
      border-radius: 12px;
      z-index: 200;
      white-space: nowrap;
    }
    .toast.show {
      display: block;
      animation: fadeout 0.5s ease 2s forwards;
    }
    @keyframes fadeout {
      to { opacity: 0; }
    }
    .logo {
      width: 80px;
      height: 80px;
      background: #30234B;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
    }
    .logo span {
      color: white;
      font-size: 36px;
      font-weight: 700;
    }
    h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #30234B;
    }
    .subtitle {
      font-size: 16px;
      color: #666;
      margin-bottom: 32px;
      line-height: 1.5;
      max-width: 320px;
    }
    .open-btn {
      display: inline-block;
      background: #30234B;
      color: white;
      font-size: 16px;
      font-weight: 600;
      padding: 14px 40px;
      border-radius: 12px;
      text-decoration: none;
      margin-bottom: 16px;
      cursor: pointer;
      border: none;
      -webkit-tap-highlight-color: transparent;
    }
    .open-btn:active { opacity: 0.9; }
    .download-btn {
      display: inline-block;
      background: transparent;
      color: #30234B;
      font-size: 15px;
      font-weight: 500;
      padding: 12px 32px;
      border-radius: 12px;
      text-decoration: none;
      border: 1.5px solid #E0E0E0;
      margin-bottom: 12px;
    }
    .download-btn:active { opacity: 0.8; }
    .links {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }
    .linktree {
      font-size: 13px;
      color: #999;
      margin-top: 24px;
    }
    .linktree a {
      color: #7B61FF;
      text-decoration: none;
    }
    .type-badge {
      display: inline-block;
      background: #F3F2F8;
      color: #30234B;
      font-size: 13px;
      font-weight: 500;
      padding: 6px 14px;
      border-radius: 20px;
      margin-bottom: 16px;
    }
    .preview-img {
      width: 100%;
      max-width: 280px;
      border-radius: 16px;
      margin-bottom: 24px;
      object-fit: cover;
      aspect-ratio: 16/9;
    }
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #E0E0E0;
      border-top-color: #30234B;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin-bottom: 24px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="iab-banner" id="iabBanner">
    <div class="iab-title" id="iabTitle"></div>
    <div class="iab-steps" id="iabSteps"></div>
    <button class="iab-copy-btn" id="iabCopyBtn"></button>
  </div>
  <div class="toast" id="toast"></div>

  <div id="logoContainer"><div class="logo"><span>M</span></div></div>
  <div class="type-badge" id="typeBadge"></div>
  <h1 id="heading"></h1>
  <p class="subtitle" id="subtitle"></p>
  <div class="links">
    <a class="open-btn" id="openBtn" href="#"></a>
    <a class="download-btn" id="downloadBtn" href="https://apps.apple.com/no/app/moments-aktiviteter/id6670760989?l=nb"></a>
    <a class="download-btn" id="googlePlayBtn" href="https://play.google.com/store/apps/details?id=no.momentsapp"></a>
  </div>
  <div class="linktree" id="linktree"></div>

  <script>
    (function() {
      var APP_STORE = 'https://apps.apple.com/no/app/moments-aktiviteter/id6670760989?l=nb';
      var path = window.location.pathname;
      var fullUrl = window.location.href;
      var match = path.match(/^\/(event|group|profile)\/([a-zA-Z0-9-]+)/);
      var type = match ? match[1] : null;
      var id = match ? match[2] : null;
      var appUrl = (type && id) ? 'momentsapp://' + type + '/' + id : null;

      var isEn = (navigator.language || '').toLowerCase().startsWith('en');

      // --- In-app browser detection ---
      var ua = navigator.userAgent || '';
      var isIAB = /FBAN|FBAV|FB_IAB|Instagram|Messenger|Musical\.ly|BytedanceWebview|Snapchat|Twitter|LinkedInApp/i.test(ua);

      // --- Strings ---
      var strings = {
        no: {
          event: 'Aktivitet',
          group: 'Gruppe',
          profile: 'Profil',
          heading: 'Se dette i Moments',
          headingFallback: 'Moments',
          subtitle: 'Trykk for \u00e5 \u00e5pne i appen. Hvis du ikke har appen, last den ned fra App Store.',
          subtitleFallback: 'Oppdag aktiviteter, bli med i grupper og m\u00f8t nye folk.',
          open: '\u00c5pne i appen',
          download: 'Last ned fra App Store',
          googlePlay: 'Last ned fra Google Play',
          linktree: 'Finn oss p\u00e5 <a href="https://linktr.ee/Moments_App">Linktree</a>',
          iabTitle: '\u26a0\ufe0f Du er i en innebygd nettleser',
          iabSteps: '1. Trykk \u22ef \u00f8verst til h\u00f8yre\n2. Velg \u00abÅpne i Safari\u00bb',
          iabCopy: 'Kopier lenke',
          iabToast: '\u2713 Lenke kopiert! Lim inn i Safari.',
          ogTitle: 'Moments \u2013 M\u00f8t nye folk',
          ogDesc: 'Oppdag aktiviteter, bli med i grupper og m\u00f8t nye folk med Moments.'
        },
        en: {
          event: 'Event',
          group: 'Group',
          profile: 'Profile',
          heading: 'View this in Moments',
          headingFallback: 'Moments',
          subtitle: 'Tap to open in the app. If you don\'t have it yet, download it from the App Store.',
          subtitleFallback: 'Discover activities, join groups, and meet new people.',
          open: 'Open in app',
          download: 'Download from App Store',
          googlePlay: 'Download from Google Play',
          linktree: 'Find us on <a href="https://linktr.ee/Moments_App">Linktree</a>',
          iabTitle: '\u26a0\ufe0f You are in an in-app browser',
          iabSteps: '1. Tap \u22ef in the top right\n2. Select "Open in Safari"',
          iabCopy: 'Copy link',
          iabToast: '\u2713 Link copied! Paste in Safari.',
          ogTitle: 'Moments \u2013 Meet new people',
          ogDesc: 'Discover activities, join groups, and meet new people with Moments.'
        }
      };

      var s = isEn ? strings.en : strings.no;

      // --- OG tags ---
      var ogTitleTag = document.querySelector('meta[property="og:title"]');
      var ogDescTag = document.querySelector('meta[property="og:description"]');
      var ogUrlTag = document.querySelector('meta[property="og:url"]');
      if (ogTitleTag) ogTitleTag.content = type ? s[type] + ' \u2013 Moments' : s.ogTitle;
      if (ogDescTag) ogDescTag.content = s.ogDesc;
      if (ogUrlTag) ogUrlTag.content = fullUrl;

      // --- Smart App Banner with deep link ---
      var smartBanner = document.getElementById('smartBanner');
      if (smartBanner && appUrl) {
        smartBanner.content = 'app-id=6670760989, app-argument=' + appUrl;
      }

      // --- Language ---
      if (isEn) {
        document.documentElement.lang = 'en';
      }

      // --- Page content ---
      var badge = document.getElementById('typeBadge');
      var heading = document.getElementById('heading');
      var subtitle = document.getElementById('subtitle');
      var openBtn = document.getElementById('openBtn');
      var downloadBtn = document.getElementById('downloadBtn');
      var googlePlayBtn = document.getElementById('googlePlayBtn');
      var linktree = document.getElementById('linktree');

      if (type) {
        badge.textContent = s[type] || '';
        heading.textContent = s.heading;
        subtitle.textContent = s.subtitle;
      } else {
        badge.style.display = 'none';
        heading.textContent = s.headingFallback;
        subtitle.textContent = s.subtitleFallback;
      }

      openBtn.textContent = s.open;
      downloadBtn.textContent = s.download;
      googlePlayBtn.textContent = s.googlePlay;
      linktree.innerHTML = s.linktree;

      if (!appUrl) {
        openBtn.href = APP_STORE;
      }

      // --- In-app browser banner ---
      if (isIAB) {
        var iabBanner = document.getElementById('iabBanner');
        var iabTitle = document.getElementById('iabTitle');
        var iabSteps = document.getElementById('iabSteps');
        var iabCopyBtn = document.getElementById('iabCopyBtn');

        iabTitle.textContent = s.iabTitle;
        iabSteps.textContent = s.iabSteps;
        iabCopyBtn.textContent = s.iabCopy;
        iabBanner.classList.add('show');

        // Add top padding to body so content isn't hidden behind banner
        document.body.style.paddingTop = '120px';

        iabCopyBtn.addEventListener('click', function() {
          copyToClipboard(fullUrl);
          showToast(s.iabToast);
        });
      }

      // --- Clipboard deep link (deferred deep linking) ---
      if (!isIAB) {
        copyToClipboard(fullUrl);
      }

      // --- Fetch event/group data from Supabase ---
      if (type && id && (type === 'event' || type === 'group')) {
        var SUPABASE_URL = 'https://ynuvtpkdxvzlmfqbuvvn.supabase.co';
        var ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InludXZ0cGtkeHZ6bG1mcWJ1dnZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTIyNDYwNzQsImV4cCI6MjAyNzgyMjA3NH0.mua9EwOROb26EnU7HOTl8thxIzBJ_ox52jzVVDCYfjg';
        var headers = { 'apikey': ANON_KEY, 'Authorization': 'Bearer ' + ANON_KEY };
        var logoContainer = document.getElementById('logoContainer');

        // Show spinner while loading
        logoContainer.innerHTML = '<div class="spinner"></div>';

        var fetchUrl = type === 'event'
          ? SUPABASE_URL + '/rest/v1/event?id=eq.' + id + '&select=title,description'
          : SUPABASE_URL + '/rest/v1/group?id=eq.' + id + '&select=title,description,header_image_path';

        console.log('[Moments] Fetching:', fetchUrl);
        fetch(fetchUrl, { headers: headers })
          .then(function(r) {
            console.log('[Moments] Response status:', r.status);
            return r.json();
          })
          .then(function(rows) {
            console.log('[Moments] Data:', rows);
            if (!rows || !rows.length) throw new Error('not found');
            var item = rows[0];

            // Update title
            if (item.title) {
              heading.textContent = item.title;
              document.title = item.title + ' \u2013 Moments';
              var ogT = document.querySelector('meta[property="og:title"]');
              if (ogT) ogT.content = item.title + ' \u2013 Moments';
            }

            // Update description
            if (item.description) {
              var desc = item.description.length > 150
                ? item.description.slice(0, 150) + '\u2026'
                : item.description;
              subtitle.textContent = desc;
              var ogD = document.querySelector('meta[property="og:description"]');
              if (ogD) ogD.content = desc;
            }

            // Resolve image
            var imagePath = null;
            if (type === 'group' && item.header_image_path) {
              imagePath = item.header_image_path;
              showImage(imagePath);
            } else if (type === 'event') {
              // Fetch first event image
              fetch(SUPABASE_URL + '/rest/v1/event_images?event_id=eq.' + id + '&select=image_path&order=sort_order.asc&limit=1', { headers: headers })
                .then(function(r) { return r.json(); })
                .then(function(imgs) {
                  console.log('[Moments] Event images:', imgs);
                  if (imgs && imgs.length && imgs[0].image_path) {
                    showImage(imgs[0].image_path);
                  } else {
                    restoreLogo();
                  }
                })
                .catch(function(err) { console.error('[Moments] Image fetch failed:', err); restoreLogo(); });
            } else {
              restoreLogo();
            }
          })
          .catch(function(err) {
            console.error('[Moments] Fetch failed:', err);
            restoreLogo();
          });

        function showImage(imgPath) {
          var img = new Image();
          img.className = 'preview-img';
          img.alt = '';
          img.src = SUPABASE_URL + '/storage/v1/object/public/event_images/' + imgPath;
          img.onload = function() { logoContainer.innerHTML = ''; logoContainer.appendChild(img); };
          img.onerror = function() { console.error('[Moments] Image load failed:', img.src); restoreLogo(); };
        }

        function restoreLogo() {
          logoContainer.innerHTML = '<div class="logo"><span>M</span></div>';
        }
      }

      // --- Open button click handler with visibility check ---
      openBtn.addEventListener('click', function(e) {
        if (!appUrl) return;
        e.preventDefault();
        window.location.href = appUrl;

        // Listen for visibility change - if app opens, page becomes hidden
        var redirectTimer = setTimeout(function() {
          if (!document.hidden) {
            window.location.href = APP_STORE;
          }
        }, 2500);

        // Cancel redirect if app opened successfully
        document.addEventListener('visibilitychange', function() {
          if (document.hidden) {
            clearTimeout(redirectTimer);
          }
        }, { once: true });
      });

      // --- Helpers ---
      function copyToClipboard(text) {
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text);
          } else {
            var ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
          }
        } catch (e) {
          // Clipboard not available — fail silently
        }
      }

      function showToast(msg) {
        var toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.classList.remove('show');
        // Force reflow for re-animation
        void toast.offsetWidth;
        toast.classList.add('show');
        setTimeout(function() {
          toast.classList.remove('show');
        }, 2500);
      }
    })();
  </script>
</body>
</html>
